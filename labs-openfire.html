<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<script src="../../bower_components/strophe-openfire-websocket/strophe-openfire-websocket.js"></script>
<script src="../../bower_components/strophe.js/strophe.js"></script>
<script src="../../bower_components/strophejs-plugins/muc/strophe.muc.js"></script>
<script src="../../bower_components/strophejs-plugins/register/strophe.register.js"></script>

<!-- 

Example: 
<labs-openfire 
                  id="openfireconnect"
                  room="astadlabs" 
                  on-logged-in="loggedin" 
                  on-chat-msg="chatreceived"
                  username="testuser"
                  password="testpass"
                  connected="{{connected}}">
                </labs-openfire> 
@demo
-->
<dom-module id="labs-openfire">
  <style>
    :host {
      display: block;
    }
  </style>
  <template>
  <iron-ajax
    id="ajax"
    url="http://kingflurkel.dtdns.net:9090/plugins/restapi/v1/users"
    headers='{"Authorization": "2Pz2ac24tMFwO5ne"}, {"Content-Type": "application/json"}'
    handle-as="json"
    method="post"
    last-response-changed="{{handleResponse}}"></iron-ajax>
  </template>
</dom-module>
<script>
(function() {

  var conn = new Openfire.Connection("ws://kingflurkel.dtdns.net:7070/ws/server");

  var app = document.querySelector('#connect');

  Polymer({
    is: 'labs-openfire',

    properties: {
      foo: {
        type: String,
        value: 'bar',
        notify: true
      },

      room: {
        type: String,
        value: 'astadlabs',
        notify: true
      },
      
      username: {
        type: String,
        notify: true
      },

      pincode: {
        type: String,
        notify: true
      },

      openfireserver: {
        type: String,
        value: "kingflurkel.dtdns.net",
        notify: true
      },

      connected: {
        type: Boolean,
        value: false
      }
    },

    joinRoom: function(username, password){
      var that = this;
      console.log('ik ga joinen he!');
      var room = this.room+"@conference.kingflurkel.dtdns.net";
      var nick = username+"@kingflurkel.dtdns.net";
      var password = password;
      var history_attrs = null;
      conn.muc.join(room, nick, that.msg_handler_cb, that.pres_handler_cb, that.roster_cb, password, history_attrs);
    },

    myFire: function(e){
      this.fire('chat-msg', {detail: e});
    },

    logIets: function(e){
      console.log('iets? ', e);
      return true;
    },

    setHandlers: function(){
      var that = this;
      conn.addHandler(that.logIets);
    },

    msg_handler_cb: function(msg){
      var to = msg.getAttribute('to');
      var from = msg.getAttribute('from');
      var type = msg.getAttribute('type');
      var elems = msg.getElementsByTagName('body');
      var body = elems[0];
      console.log('Received ',type, ' ','message from ', from, ' to: ', to, ' Contents: ', body);
      return true;
    },

    pres_handler_cb: function(){
      console.log('presence handler');
      return true;
    },

    roster_cb: function(){
      console.log('roster handler');
      return true;
    },

    /**
     * Create a user on openfire server. Authenticate after user registration. Needs username and password.
     Example: this.$.openfire.createUser(username, password);
     */

    createUser: function(username, pincode){
        var ajax = this.$.ajax;
        ajax.body = '{"username": username, "password": pincode}';
        ajax.generateRequest();
    },

    handleResponse: function(){
      console.log('het heeft iets gedaan');
    },

    sendTest: function(){
      var message = "just a test";
      var reply = $msg({
        to: 'kingflurkel@kingflurkel.dtdns.net',
        type: 'chat'
      })
      .cnode(Strophe.xmlElement('body', message)).up()
      .c('active', {xmlns: "http://jabber.org/protocol/chatstates"});
      conn.send(reply);
      return true;
    },

    login: function(){

      var that = this;
      var username = this.username;
      var password = this.password;

      conn.connect(username, password, function(status){
        if (status === Strophe.Status.CONNECTED) {
          console.log('connected');
          that.joinRoom(username, password);
          conn.addHandler(that.logIets);
          conn.send($pres().tree());
          //that.sendTest();
          that.fire('logged-in');
          that.connected = true;
        } else if (status === Strophe.Status.DISCONNECTED) {
            //$(document).trigger('disconnected');
          //console.log('no yoooo');
          that.fire('disconnected');
          that.connected = false;
        };
      });

      //console.log('Button is geklikt. User: ', username, ' Pass: ', password);
    }
  });
})();
</script>
